Название: С2 архитектуры 
Автор: Войтещук Анна
Дата: 21.12.2025

Контекст
Ограниченные контексты доменной оболасти
	Домен: PigSystem как система				
	Поддомен: Взаимодействие с пользователями			
		Контекст: Многофакторная аутентификация		UC0-2
		Контекст: Управление доступами		UC0-1
		Контекст: API для клиентских приложений		UC0-3, RI1
		Контекст: Отслеживание активности пользователя		ADR2-1
	Поддомен: Взаимодействие с внешними системами			
		Контекст: Интеграция с внешними системами		RI3-1, RI3-2
	Поддомен: Поддержание целостности системы			
		Контекст: Хранение данных		RA1
		Контекст: Мониторинг связи		RA1, RA2, R2-1, UC0-5, UC0-6
	Домен: Уход за животными				
		Поддомен: Присмотр за животными			
			Контекст: Мониторинг поведения животных		UC1-0
			Контекст: Мониторинг состояния животных		UC1-1
		Поддомен: Кормление животных			
			Контекст: Автоматизация кормления		UC2-1, UC2-2, UC2-3, UC2-4, UC3-1, UC3-2, UC3-3, UC3-4, 
			Контекст: Снабжение кормом		
				Контекст: Мониторинг запасов	UC4-1
				Контекст: Прогнозирование запасов	UC4-2
	Домен: Использование оборудования автоматизации				UC4-3
		Поддомен: Учет полевого оборудования			
			Контекст: Ведение полевой карты		RE1-4 RE2-1
			Контекст: Мониторинг состояния полевого оборудования		ADR2-2
		Поддомен: Взаимодействие с полевым оборудованием			
			Контекст: Схемы интеграции		S1
			Контекст: Распознавание поведения животных		N3
			Контекст: Интеграционный мост		ADR2-3

Проблема
	Какая С2 архитектуры реализует функциональные и нефункциональные требования
	
Решение
	Диаграмма-домены - описывает ограниченные контексты бизнес-модели
	Диаграмма-контекстная карта автоматизации - описывает взаимосвязи контекстов для функции автоматизации ухода за животными
	Диаграмма-контекстная карта снабжения - описывает взаимосвязи контекстов для функции снабжения запасами корма

	Диаграмма инфраструктуры1 - описывает систему с точки зрения поддержания ее целостности
	Диаграмма инфраструктуры2 
	Диаграмма оборудования - описывает необходимую схему оборудования сервер-агентов на фермах

	Диаграмма интеграции микросервисов - описывает взаимодействие микросервисов

ADL выделения контекстов
	ADR2-1	 Контекст: Отслеживание активности пользователя - может быть важно для расследования прошедших инцидентов
	ADR2-2	 Контекст: Мониторинг состояния полевого оборудования - пользователь будет знать, когда часть его цифровых глаз на самом деле не работает и не пропустит важные события вне присмотра
	ADR2-3	 Контекст: Интеграционный мост - IOT шлюз как единая точка выхода в интернет, для снижения нагрузки на облако, работа в условиях обрыва связи, упрощает развертывание и обслуживание большого количества устройств
	
ADL оборудования
	RE0-1	
	"Нестабильный Wi-Fi
	Для видео камер - Ethernet - стабильный, надежный канал связи, не подверженный помехам, свойственным WiFi
	Для устройств, которые не требуют пропускной способности видео - LoRaWAN - позволяет передавать небольшие пакеты данных на большие расстояния в условиях фермы. Уже используются компанией

	Для стабильного Wi-Fi
	Mesh-сеть на промышленных точках доступа (Industrial Wi-Fi Mesh)
	Устойчивость к помехам, Резервирование маршрутов.
	Все еще подвержена некоторым ограничениям WiFi, но в гораздо меньшей степени, чем бытовое оборудование."
	"P2
	
	RE1-1	RE1-3
	"	"Исключает вариант анализа видеопотока в облаке - только на территории фермы
	- либо ИИ-агент на самой видеокамере
	- либо ИИ-сервис на IOT шлюзе с мощным GPU + Gigabit Ethernet

	Первые дороже и для каждого производителя писать свой ИИ-агент, зато условно неограниченное кол-во подключений
	Вторые дешевле, но масштабирование ограничено мощностью шлюза (ориентировочно 20-30 камер на 1 сервер)"
	
	RE1-2	Чтобы снимать при проблемах с освещением, камеры должны иметь ИК-подсветку с достаточным радиусом действия для загонов
	RE2-1	Чтобы управлять поилками и кормушками разных устройств, необходим адаптер, который будет приводить диалог с устройством специфического производителя к стандартному для PigSystem устройству
	RE1-4	
	"Чтобы поддерживать камеры от максимум производителей:
	Решение: ""Схема ИИ-сервис + видеопоток по Gigabit Ethernet по протоколу RTSA 
	Обеспечивает самый широкий выбор видеокамер
	Риск: можно не уложиться в требование по скорости реакции
	Решение: ""Схема ИИ-сервис + видеопоток по Gigabit Ethernet по протоколу gRPC
	Протокол высокопроизводительный и сократит время реакции на аналитику
	Риск: Меньше производителей камер поддерживают видеопоток по gRPC.
	Решение: IOT-камеры с настраиваемой ИИ на борту
	Самый быстрая реакция
	Риски: Производительности камеры не хватит для ИИ со сложной моделью вычислений
	Нужно под каждого производителя разрабатывать свой ИИ-агент 
	Нужно настраивать и автоматизировать способ развертывания и обновления ИИ-агентов на устройствах"
	
	N3	
	"Чтобы обеспечить максимальную производительность и миллисекундный отклик.
	Закупаемый Edge AI Server должен иметь GPU, совместимый с форматом предоставленной партнерами нейросетевой модели, "
	N2	
	"От ИИ модели требуется ""Мультиобъектный трекинг"" - должна уникально идентифицировать каждую особь на протяжении всего видеопотока.
	Есть риск, что у нее не получится
	Тогда рассмотреть вариант использования RFID-меток для животных и их считывателей"
	N1	
	Рассмотреть вариант использования RFID-меток для животных и их считывателей или других способов идентификации особей
	R1	
	"Чтобы обеспечить отказоустойчивость 99,95% (4,38 часа в год) на уровне оборудования
	Принцип избыточности - Каждый критически важный компонент системы должен дублироваться
	- 2 канала выхода в интернет, 2 провайдера выхода в интернет
	- агент-сервер на ферме - кластер из 2ух (Active-StandBy или Active-Active)"

ADL инфраструктуры
	"UC0-1	UC0-2"	
	"Для аутентификации используем KeyCloak - OpenSource решение для Identity Provider корпоративного уровня.
	Он реализует современные и безопасные протоколы. Позволяет гибко определить ""поток аутентификации"" для разных ролей. Полный контроль над данными. Не требует оплаты.

	Риски и ограничения:
	Мы отвечаем за правильную настройку инфраструктуры, резервное копирование, своевременное обновление и масштабирование
	Долгий Time-to-Market: Хотя развернуть базовую версию быстро, настройка production-ready кластера, интеграция MFA, кастомизация UI/UX займут гораздо больше времени, чем использование готовых облачных SDK.
	Мы несем риски безопасности по настройке и предотвращению утечек.

	Альтернатива:
	Сторонние облачные IdentityProviders Российского происхождения:
	Мгновенный запуск и быстрый Time-to-Market
	Минимальная операционная нагрузка
	Автоматическое соответствие стандартам

	Риски и ограничения альтернативы
	Постоянные расходы (CAPEX/OPEX): Это платная подписка. Стоимость может стать значительной по мере роста числа пользователей
	Зависимость от вендора (Vendor Lock-in): Миграция с одного облачного IdP на другой — сложный и болезненный процесс.
	Меньший контроль и гибкость"
	UC0-3	"Для авторизации и единой точки доступа к API используем Kong Gateway - OpenCore решение для API Gateway. 
	Интегрируется с Keycloak. 
	Компромиссы: Более тяжеловесный, чем обратный прокси. Нужна эксперность в Kong, Nginx

	Альтернативы 
	Облачный API Gateway - платная подписка, зависит от масштабирования, ограниченная кастомизация, затрудненная миграция
	Traefik - обратный прокси, более легковесный вариант входной точки. Интегрируется с Keycloak.Можно использовать на этапе MVP"
	RI1	"API Gateway (Шлюз API) как единая точка входа для клиентского приложения

	Альтернативы:
	BFF Сервис (Backend for Frontend) для Web интерфейса
	BFF Сервис для Мобильного приложения"
	
	UC0-4	Сервис оповещения пользователя
	"UC5-1	UC5-2"	Сервис интеграции с внешними системами
	"R2-2	R2-3	UC0-5	UC0-6"	
	"Сервис синхронизации с центральным сервером на ферме
	Сервис приема синхронизации с фермами на центральном сервере
	Связываются по 
	gRPC - высокопроизводителен - эффективен для больших объемов данных, возможен стрим в обоих направлениях, терпимо относится к непостоянному интернет-соединению.
	сериализует в компактный формат
	хорошо управляет переподключениями при обрывах связи

	Альтернатива - публикация напрямую в центральный кластер брокера
	Этот протокол может быть чувствителен к длительным задержкам (высокому пингу) и нестабильным интернет-соединения
	Для работы через интернет ему требуется VPN или прямое защищенное соединение, что повышает сложность настройки сети на фермах."
	ADR
	"Для шины сообщений с IOT устройствами выбрали RabbitMQ
	Легковесен, кластеризуем, имеет поддержку MQTT, гарантирует получение сообщений"	
	ADR
	"Для включения событий IOT устройств в среду системы используем IOT шлюз
	Как точку фильтрации входящих сообщений.
	Компромиссы: добавляется уровень в цепочке обработки события, а значит удлиняется период реакции"	
	
ADL Микросервисы и их взаимодействие	
		"Чтобы соответствовать требованиям ""расширяемая, масштабируемая архитектура""
	Для интеграции микросервисов выбран тип асинхронная публикация-подписка. 
	Позволяет подстраиваться микросервисам под разнородную нагрузку.
	Позволяет подстраиваться под непроясненные требования бизнеса к интерфейсам управления и автоматизации
	Компромиссы: увеличивается объем для разработки, усложняется отладка"
		"Контекст: На первом уровне MVP важно проверить саму схему автоматизации. 
	Решение: 
	На первом этапе реализовать группу микросервисов операционного управления фермой, как модульный монолит, чтобы не реализовывать репликацию данных о полевой карте, некритичной для успеха MVP.
	Разделить его на втором уровне MVP, когда будет проверяться схема масштабирования
	Цель: Ускорение доставки первой версии MVP
	Компромиссы: При реализации модулей возможны ошибки в проектировании, которые проявятся только на этапе разделения."
		RA1
		"Для локальной шины сообщений выбран RabbitMQ Streams
	Легковесный и при этом поддерживает концепцию распределенного лога
	Цель: 
	Минимизация требования к оборудованию сервер-агента, упрощение администрирования, упрощение отладки цепочки событий
	Минимимум усилий для переноса микросервисов на шину Kafka и обратно при необходимости
	Компромиссы: 
	Поток событий фермы может превысить пропускную способность, и потребуется переход на Kafka
	RabbitMQ Streams молод и может приподнести сюрпризы"

Альтернативы
"1. Хостинг центрального сервера
	A или в облаке (Cloud) - у облачного провайдера
	B или самостоятельный (OnPremise) - на собственном физическом оборудовании"
	
	A
	"Преимущества облака:
	- простая и быстрая масштабируемость - использование программно-аппаратных ресурсов провайдера в зависимости от нагрузки на систему
	- фокус на продукте и скорость результата - использование готовых инфрастуктурных модулей провайдера позволяет заниматься только бизнес логикой уникальной для проекта
	- гибкость - набор готовых модулей провайдера позволяет быстро пересобрать инфраструктуру систему под ситуацию
	- экономия на старте - не нужно покупать серверное оборудование, оплата по факту использования
	- высокая надежность и доступность, обеспечиваемая провайдером
	- наиболее подходящая платформа для SaaS
	- географическое распределение - возможность размешаться в разных регионах для минимальной задержки

	Недостатки облака
	- зависимость кода от конкретного облачного провайдера
	- потенциально высокие расходы на больших объемах системы

	Компромиссы: важно использовать Российских провайдеров"
	
	B
	"Преимущества OnPremise
	- полный контроль над безопасностью системы
	- упрощает соблюдение регуляторных требований
	- предсказуемые затраты на сопровождение

	Недостатки OnPremise
	- высокие затраты на старт
	- сложная эксплуатация и управление - ответственность за обслуживание оборудования, за настройку среды безопасности, за администрирование инфраструктуры
	- медленное масштабирование - добавление новых мощностей требует закупки-досткавки-установки
	- усложняет запуск SaaS решений для множества мелких и средних клиентов"
	
"2. Операционное управление фермой:
	A из центра
	B локально"

	A
		"Преимущества операционного управления из центра
		- глобальный контроль
		- простота обновления
		- эффективность использования разделяемых ресурсов для Saas решения

		Недостатки
		- Зависимость деятельности фермы от интернета
		- Задержка в реагировании"
	
	B
		"Преимущества операционного управления локально
		- Автономность и надежность - независимо от интернета
		- Низкая задержка

		Минусы
		- сложность обновления
		- Распределенная сложность
		- Повышенные требования к локальному оборудованию
		- Размывание преимуществ ""облачности"""
		
"3. Покрытие территории фермы
	A видеокамерами с ИИ на борту 
	B видеокамерами с трансляцией видеопотока на локальный ИИ-агент"

	A
	"Преимущества видеокамер с ИИ на борту
	- минимальные требования к трафику
	- мгновенная реакция
	- снижение нагрузки на сервер
	- высокий потенциал масштабирования

	Недостатки
	- высокая стоимость оборудования
	- сложность обновления ИИ-моделей
	- ограниченная мощность ИИ"
	
	B
	"Преимущества видеокамер + серверный ИИ-агент
	- низкая стоимость камер
	- высокий выбор производителей
	- мощный ИИ-анализ
	- централизованное управление ИИ

	Минусы
	- высокие требования к сети и трафику
	- высокая стоимость сервер
	- задержка выше
	- сложности при масштабирования больше чем возможности сервера"